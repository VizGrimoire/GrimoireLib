<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>vizgrimoire.GrimoireUtils &mdash; GrimoreLib 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="GrimoreLib 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">GrimoreLib 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for vizgrimoire.GrimoireUtils</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>

<span class="c"># Copyright (C) 2014 Bitergia</span>
<span class="c"># </span>
<span class="c"># This program is free software; you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation; either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with this program; if not, write to the Free Software</span>
<span class="c"># Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Authors:</span>
<span class="c">#     Alvaro del Castillo &lt;acs@bitergia.com&gt;</span>

<span class="c"># Misc utils</span>

<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="kn">import</span> <span class="n">SafeConfigParser</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">dateutil</span> <span class="kn">import</span> <span class="n">parser</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">rpy2.rinterface</span> <span class="kn">as</span> <span class="nn">rinterface</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects.vectors</span> <span class="kn">import</span> <span class="n">StrVector</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">average</span><span class="p">,</span> <span class="n">median</span>

<div class="viewcode-block" id="valRtoPython"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.valRtoPython">[docs]</a><span class="k">def</span> <span class="nf">valRtoPython</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">rinterface</span><span class="o">.</span><span class="n">NA_Character</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Check for .0 and convert to int</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="n">StrVector</span><span class="p">):</span>
        <span class="n">val2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span> <span class="n">val2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val2</span>
    <span class="k">return</span> <span class="n">val</span>

</div>
<div class="viewcode-block" id="createTimeSeries"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.createTimeSeries">[docs]</a><span class="k">def</span> <span class="nf">createTimeSeries</span><span class="p">(</span><span class="n">ts_data</span><span class="p">):</span>
    <span class="n">new_ts_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># TODO: old format from R JSON. To be simplified</span>
    <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;unixtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="n">ts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span> <span class="n">new_ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">new_ts_data</span>

<span class="c"># Check that all list entries are arrays</span></div>
<div class="viewcode-block" id="checkListArray"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.checkListArray">[docs]</a><span class="k">def</span> <span class="nf">checkListArray</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>

<span class="c"># NaN converted to 0</span></div>
<div class="viewcode-block" id="cleanNaN"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.cleanNaN">[docs]</a><span class="k">def</span> <span class="nf">cleanNaN</span><span class="p">(</span><span class="n">ts_data</span><span class="p">):</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="n">ts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">)):</span> <span class="n">ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ts_data</span>

</div>
<div class="viewcode-block" id="completePeriodIdsYears"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.completePeriodIdsYears">[docs]</a><span class="k">def</span> <span class="nf">completePeriodIdsYears</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="n">ts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">new_ts_data</span> <span class="o">=</span>  <span class="n">createTimeSeries</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>
    <span class="n">checkListArray</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>

    <span class="n">start_year</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">year</span> <span class="o">*</span> <span class="mi">12</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">start</span><span class="o">.</span><span class="n">year</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">years</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start_year</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ts_data</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="c"># Add new time point with all vars to zero</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span>
                <span class="n">new_ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_year</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">12</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Add already existing data for the time point</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">ts_data</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_year</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">12</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span>
                <span class="n">new_ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>

        <span class="n">current</span> <span class="o">=</span>  <span class="n">start</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;unixtime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s">&quot;%b %Y&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_ts_data</span>

</div>
<div class="viewcode-block" id="completePeriodIdsMonths"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.completePeriodIdsMonths">[docs]</a><span class="k">def</span> <span class="nf">completePeriodIdsMonths</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="n">ts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">new_ts_data</span> <span class="o">=</span>  <span class="n">createTimeSeries</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>
    <span class="n">checkListArray</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>

    <span class="n">start_month</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="n">start</span><span class="o">.</span><span class="n">month</span>
    <span class="n">end_month</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="n">end</span><span class="o">.</span><span class="n">month</span>
    <span class="n">months</span> <span class="o">=</span> <span class="n">end_month</span> <span class="o">-</span> <span class="n">start_month</span>

    <span class="c"># All data is from the complete month</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">day</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">months</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start_month</span><span class="o">+</span><span class="n">i</span> <span class="ow">in</span> <span class="n">ts_data</span><span class="p">[</span><span class="s">&#39;month&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="c"># Add new time point with all vars to zero</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span>
                <span class="n">new_ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_month</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Add already existing data for the time point</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">ts_data</span><span class="p">[</span><span class="s">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_month</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span>
                <span class="n">new_ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>

        <span class="n">current</span> <span class="o">=</span>  <span class="n">start</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;unixtime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">locale</span>
        <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&quot;en_US.UTF-8&quot;</span><span class="p">)</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s">&quot;%b %Y&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_ts_data</span>
</div>
<div class="viewcode-block" id="date2Week"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.date2Week">[docs]</a><span class="k">def</span> <span class="nf">date2Week</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="c"># isocalendar: year weeknumber weekday</span>
    <span class="n">week</span>   <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">week</span>  <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%02d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">week</span>
</div>
<div class="viewcode-block" id="completePeriodIdsWeeks"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.completePeriodIdsWeeks">[docs]</a><span class="k">def</span> <span class="nf">completePeriodIdsWeeks</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="n">ts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">new_ts_data</span> <span class="o">=</span>  <span class="n">createTimeSeries</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>
    <span class="n">checkListArray</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>

    <span class="c"># Start of the week</span>
    <span class="n">dayweek</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">new_week</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">dayweek</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># for ids in time series</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">new_week</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">new_week_txt</span> <span class="o">=</span> <span class="n">date2Week</span><span class="p">(</span><span class="n">new_week</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">new_week_txt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ts_data</span><span class="p">[</span><span class="s">&#39;week&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="c"># Add new time point with all vars to zero</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span>
                <span class="n">new_ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;week&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;week&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">new_week_txt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Add already existing data for the time point</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">ts_data</span><span class="p">[</span><span class="s">&#39;week&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">new_week_txt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data_vars</span><span class="p">):</span>
                <span class="n">new_ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
            <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;week&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;week&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_data</span><span class="p">[</span><span class="s">&#39;week&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">new_week</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;unixtime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">new_ts_data</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">new_week</span><span class="p">,</span> <span class="s">&quot;%b %Y&quot;</span><span class="p">))</span>
        <span class="n">new_week</span> <span class="o">=</span> <span class="n">new_week</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_ts_data</span>
</div>
<div class="viewcode-block" id="completePeriodIds"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.completePeriodIds">[docs]</a><span class="k">def</span> <span class="nf">completePeriodIds</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">):</span>
    <span class="c"># If already complete, return</span>
    <span class="k">if</span> <span class="s">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">ts_data</span><span class="p">:</span> <span class="k">return</span> <span class="n">ts_data</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">ts_data</span>
    <span class="n">new_ts_data</span> <span class="o">=</span> <span class="n">ts_data</span>
    <span class="n">startdate</span> <span class="o">=</span> <span class="n">startdate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">enddate</span> <span class="o">=</span> <span class="n">enddate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">enddate</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="s">&quot;week&quot;</span><span class="p">:</span>
        <span class="n">new_ts_data</span> <span class="o">=</span> <span class="n">completePeriodIdsWeeks</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s">&quot;month&quot;</span><span class="p">:</span>
        <span class="n">new_ts_data</span> <span class="o">=</span> <span class="n">completePeriodIdsMonths</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s">&quot;year&quot;</span><span class="p">:</span>
        <span class="n">new_ts_data</span> <span class="o">=</span> <span class="n">completePeriodIdsYears</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cleanNaN</span><span class="p">(</span><span class="n">new_ts_data</span><span class="p">)</span>

<span class="c"># Convert a R data frame to a python dictionary</span></div>
<div class="viewcode-block" id="dataFrame2Dict"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.dataFrame2Dict">[docs]</a><span class="k">def</span> <span class="nf">dataFrame2Dict</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">dict_</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># R start from 1 in data frames</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="c"># Get the columns data frame</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">colname</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">colvalues</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dict_</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colvalues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">dict_</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">valRtoPython</span><span class="p">(</span><span class="n">colvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">colvalues</span><span class="p">:</span> 
                <span class="n">dict_</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valRtoPython</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dict_</span>
</div>
<div class="viewcode-block" id="getPeriod"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.getPeriod">[docs]</a><span class="k">def</span> <span class="nf">getPeriod</span><span class="p">(</span><span class="n">granularity</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">period</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">nperiod</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">granularity</span> <span class="o">==</span> <span class="s">&#39;years&#39;</span><span class="p">):</span>
        <span class="n">period</span> <span class="o">=</span> <span class="s">&#39;year&#39;</span>
        <span class="n">nperiod</span> <span class="o">=</span> <span class="mi">365</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">granularity</span> <span class="o">==</span> <span class="s">&#39;months&#39;</span><span class="p">):</span> 
        <span class="n">period</span> <span class="o">=</span> <span class="s">&#39;month&#39;</span>
        <span class="n">nperiod</span> <span class="o">=</span> <span class="mi">31</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">granularity</span> <span class="o">==</span> <span class="s">&#39;weeks&#39;</span><span class="p">):</span> 
        <span class="n">period</span> <span class="o">=</span> <span class="s">&#39;week&#39;</span>
        <span class="n">nperiod</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">granularity</span> <span class="o">==</span> <span class="s">&#39;days&#39;</span><span class="p">):</span> 
        <span class="n">period</span> <span class="o">=</span> <span class="s">&#39;day&#39;</span>
        <span class="n">nperiod</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Incorrect period:&quot;</span><span class="p">,</span><span class="n">granularity</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">number</span><span class="p">):</span> <span class="k">return</span> <span class="n">nperiod</span>
    <span class="k">return</span> <span class="n">period</span>

</div>
<div class="viewcode-block" id="removeDecimals"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.removeDecimals">[docs]</a><span class="k">def</span> <span class="nf">removeDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert Decimal type to float &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">removeDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">removeDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">removeDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="roundDecimals"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.roundDecimals">[docs]</a><span class="k">def</span> <span class="nf">roundDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Limit the max number of decimals in floats &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">Metrics</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">max_decimals</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">roundDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">roundDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">max_decimals</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">roundDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span>

</div>
<div class="viewcode-block" id="convertDatetime"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.convertDatetime">[docs]</a><span class="k">def</span> <span class="nf">convertDatetime</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">datetime</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">convertDatetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">convertDatetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">datetime</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c"># Until we use VizPy we will create JSON python files with _py</span></div>
<div class="viewcode-block" id="createJSON"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.createJSON">[docs]</a><span class="k">def</span> <span class="nf">createJSON</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">skip_fields</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># for production mode</span>
    <span class="n">filepath_tokens</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.json&quot;</span><span class="p">)</span>
    <span class="n">filepath_py</span> <span class="o">=</span> <span class="n">filepath_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;_py.json&quot;</span>
    <span class="n">filepath_r</span> <span class="o">=</span> <span class="n">filepath_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;_r.json&quot;</span>

    <span class="n">checked_data</span> <span class="o">=</span> <span class="n">convertDatetime</span><span class="p">(</span><span class="n">roundDecimals</span><span class="p">(</span><span class="n">removeDecimals</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">checked_data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;NaN&#39;</span><span class="p">,</span><span class="s">&#39;&quot;NA&quot;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span> <span class="c">#forget about R JSON checking</span>
        <span class="n">jsonfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">jsonfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">jsonfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="c"># NA as value is not decoded with Python JSON</span>
    <span class="c"># JSON R has &quot;NA&quot; and not NaN</span>
    <span class="c"># JSON R has &quot;NA&quot; and not null</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;NA&#39;</span><span class="p">,</span><span class="s">&#39;&quot;NA&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;NaN&#39;</span><span class="p">,</span><span class="s">&#39;&quot;NA&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;null&#39;</span><span class="p">,</span><span class="s">&#39; &quot;NA&quot; &#39;</span><span class="p">)</span>
    <span class="n">jsonfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath_py</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">jsonfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">jsonfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">check</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">compareJSON</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">filepath_py</span><span class="p">,</span> <span class="n">skip_fields</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Wrong data generated from Python &quot;</span><span class="o">+</span> <span class="n">filepath_py</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Rename the files so Python JSON is used</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">filepath_r</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filepath_py</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="compareJSON"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.compareJSON">[docs]</a><span class="k">def</span> <span class="nf">compareJSON</span><span class="p">(</span><span class="n">orig_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">,</span> <span class="n">skip_fields</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">orig_file</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
        <span class="n">f1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">f2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Fail comparing JSON files:&quot;</span><span class="p">,</span> <span class="n">orig_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>


    <span class="k">return</span> <span class="n">compare_json_data</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">orig_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">,</span> <span class="n">skip_fields</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="compare_json_data"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.compare_json_data">[docs]</a><span class="k">def</span> <span class="nf">compare_json_data</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">orig_file</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">new_file</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">skip_fields</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; Compare two JS objects read from a JSON file or created from code &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">orig_file</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">):</span> <span class="n">orig_file</span> <span class="o">=</span> <span class="s">&quot;orig data&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new_file</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">):</span> <span class="n">orig_file</span> <span class="o">=</span> <span class="s">&quot;new data&quot;</span>

    <span class="n">check</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;More data in &quot;</span> <span class="o">+</span> <span class="n">orig_file</span> <span class="o">+</span> <span class="s">&quot; than in &quot;</span><span class="o">+</span>
                     <span class="n">new_file</span> <span class="o">+</span><span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span> <span class="p">(</span><span class="n">data2</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data2</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span> <span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span> <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;NA&quot;</span> <span class="ow">and</span> <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;is not&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data2</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span> <span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; does not exists in &quot;</span> <span class="o">+</span> <span class="n">new_file</span><span class="p">)</span>
                <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span> <span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span> <span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">]):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Different list size for &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span> <span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span> <span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span> <span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;&#39; different in dicts</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span> <span class="p">(</span><span class="s">&quot;At position &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;NA&quot;</span> <span class="ow">and</span> <span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">skip_fields</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warn</span> <span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;&#39; (skipped) different in dicts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="c"># str(data1[name]) + &quot;\n&quot; + str(data2[name]))</span>
                    <span class="k">continue</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span> <span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;&#39; different in dicts</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
                <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data1</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span> <span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; does not exists in &quot;</span> <span class="o">+</span> <span class="n">orig_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Failed check for &quot;</span> <span class="o">+</span> <span class="n">orig_file</span> <span class="o">+</span> <span class="s">&quot; and &quot;</span> <span class="o">+</span> <span class="n">new_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">check</span>
</div>
<div class="viewcode-block" id="GetDates"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.GetDates">[docs]</a><span class="k">def</span> <span class="nf">GetDates</span> <span class="p">(</span><span class="n">last_date</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
    <span class="n">enddate</span> <span class="o">=</span> <span class="n">last_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>

    <span class="n">enddate</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">enddate</span><span class="p">)</span>
    <span class="n">startdate</span> <span class="o">=</span> <span class="n">enddate</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
    <span class="n">prevdate</span> <span class="o">=</span> <span class="n">startdate</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>

    <span class="n">chardates</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span><span class="p">]</span>
    <span class="n">chardates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="n">chardates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">prevdate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">chardates</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GetPercentageDiff"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.GetPercentageDiff">[docs]</a><span class="k">def</span> <span class="nf">GetPercentageDiff</span> <span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">):</span>
    <span class="c"># This function returns the % diff between value 1 and value 2.</span>
    <span class="c"># The difference could be positive or negative, but the returned value</span>
    <span class="c"># is always &gt; 0</span>

    <span class="n">percentage</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">value1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value1</span> <span class="ow">is</span> <span class="bp">None</span>  <span class="ow">or</span> <span class="n">value2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">value1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span>
    <span class="n">value2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">value1</span> <span class="o">&lt;</span> <span class="n">value2</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value2</span> <span class="o">-</span> <span class="n">value1</span><span class="p">)</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">diff</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">value1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value1</span> <span class="o">&gt;</span> <span class="n">value2</span><span class="p">):</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">value2</span><span class="o">/</span><span class="n">value1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">percentage</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="checkFloatArray"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.checkFloatArray">[docs]</a><span class="k">def</span> <span class="nf">checkFloatArray</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="read_main_conf"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.read_main_conf">[docs]</a><span class="k">def</span> <span class="nf">read_main_conf</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">SafeConfigParser</span><span class="p">()</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">readfp</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">sec</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>
    <span class="c"># we&#39;ll read &quot;generic&quot; for db information and &quot;r&quot; for start_date and &quot;bicho&quot; for backend</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sec</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">((</span><span class="n">s</span> <span class="o">==</span> <span class="s">&quot;generic&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="s">&quot;bicho&quot;</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">options</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">opti</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opti</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">options</span>

<span class="c"># Old code moved to query_builder. To be removed once it is not needed.</span></div>
<div class="viewcode-block" id="get_subprojects"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.get_subprojects">[docs]</a><span class="k">def</span> <span class="nf">get_subprojects</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">dsquery</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return all subprojects ids for a project in a string join by comma &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">GrimoireSQL</span> <span class="kn">import</span> <span class="n">ExecuteQuery</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">ExecuteQuery</span>
    <span class="k">if</span> <span class="n">dsquery</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">query</span> <span class="o">=</span> <span class="n">dsquery</span><span class="o">.</span><span class="n">ExecuteQuery</span>

    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT project_id from </span><span class="si">%s</span><span class="s">.projects WHERE id=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="s">&#39;project_id&#39;</span><span class="p">]</span>

    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT subproject_id from </span><span class="si">%s</span><span class="s">.project_children pc where pc.project_id = &#39;</span><span class="si">%s</span><span class="s">&#39;</span>
<span class="s">    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">project_id</span><span class="p">)</span>

    <span class="n">subprojects</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subprojects</span><span class="p">[</span><span class="s">&#39;subproject_id&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">subprojects</span><span class="p">[</span><span class="s">&#39;subproject_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">subprojects</span><span class="p">[</span><span class="s">&#39;subproject_id&#39;</span><span class="p">]]</span>

    <span class="n">project_with_children</span> <span class="o">=</span> <span class="n">subprojects</span><span class="p">[</span><span class="s">&#39;subproject_id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">project_id</span><span class="p">]</span>
    <span class="n">project_with_children_str</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">project_with_children</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">project_with_children_str</span>
</div>
<div class="viewcode-block" id="completeTops"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.completeTops">[docs]</a><span class="k">def</span> <span class="nf">completeTops</span><span class="p">(</span><span class="n">tops</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">backend_name</span><span class="o">=</span><span class="s">&#39;bugzilla&#39;</span><span class="p">):</span>
    <span class="n">completed_tops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tops</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">completed_tops</span><span class="p">[</span><span class="s">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">completed_tops</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">issue_id</span> <span class="ow">in</span> <span class="n">tops</span><span class="p">[</span><span class="s">&#39;issue_id&#39;</span><span class="p">]:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="n">issue_id</span><span class="p">]</span>
        <span class="n">completed_tops</span><span class="p">[</span><span class="s">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">completed_tops</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buildIssueURL</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">issue_id</span><span class="p">,</span> <span class="n">backend_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">completed_tops</span>
</div>
<div class="viewcode-block" id="buildIssueURL"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.buildIssueURL">[docs]</a><span class="k">def</span> <span class="nf">buildIssueURL</span><span class="p">(</span><span class="n">tracker_url</span><span class="p">,</span> <span class="n">issue_id</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s">&#39;bugzilla&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&#39;bugzilla&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">tracker_url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/buglist.cgi&#39;</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">tracker_url</span><span class="p">[:</span><span class="n">offset</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;/show_bug.cgi?id=&#39;</span> <span class="o">+</span> <span class="n">issue_id</span>
    <span class="k">return</span> <span class="n">url</span>

</div>
<div class="viewcode-block" id="get_median"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.get_median">[docs]</a><span class="k">def</span> <span class="nf">get_median</span><span class="p">(</span><span class="n">period_values</span><span class="p">):</span>
    <span class="c"># No data for this period</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">period_values</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;nan&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">period_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">period_values</span>
    <span class="k">return</span> <span class="n">median</span><span class="p">(</span><span class="n">removeDecimals</span><span class="p">(</span><span class="n">period_values</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="get_avg"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.get_avg">[docs]</a><span class="k">def</span> <span class="nf">get_avg</span><span class="p">(</span><span class="n">period_values</span><span class="p">):</span>
    <span class="c"># No data for this period</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">period_values</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;nan&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">period_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">period_values</span>
    <span class="k">return</span> <span class="n">average</span><span class="p">(</span><span class="n">removeDecimals</span><span class="p">(</span><span class="n">period_values</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="medianAndAvgByPeriod"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.medianAndAvgByPeriod">[docs]</a><span class="k">def</span> <span class="nf">medianAndAvgByPeriod</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_period</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="s">&#39;month&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span> <span class="k">return</span> <span class="bp">None</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">period</span>  <span class="p">:</span> <span class="p">[],</span>
              <span class="s">&#39;median&#39;</span> <span class="p">:</span> <span class="p">[],</span>
              <span class="s">&#39;avg&#39;</span>    <span class="p">:</span> <span class="p">[]}</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">current_period</span> <span class="o">=</span> <span class="n">get_period</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">period_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ndates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndates</span><span class="p">):</span>
        <span class="n">date_period</span> <span class="o">=</span> <span class="n">get_period</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c"># Change of period</span>
        <span class="k">if</span> <span class="n">date_period</span> <span class="o">!=</span> <span class="n">current_period</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_period</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;median&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_median</span><span class="p">(</span><span class="n">period_values</span><span class="p">))</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;avg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_avg</span><span class="p">(</span><span class="n">period_values</span><span class="p">))</span>

            <span class="n">current_period</span> <span class="o">=</span> <span class="n">date_period</span>
            <span class="n">period_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">period_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c"># End of the list</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ndates</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_period</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;median&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_median</span><span class="p">(</span><span class="n">period_values</span><span class="p">))</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;avg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_avg</span><span class="p">(</span><span class="n">period_values</span><span class="p">))</span>                        <span class="c"># Accumulated values</span>
    <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="check_array_values"><a class="viewcode-back" href="../../vizgrimoire.GrimoireUtils.html#vizgrimoire.GrimoireUtils.check_array_values">[docs]</a><span class="k">def</span> <span class="nf">check_array_values</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span> <span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">data</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">GrimoreLib 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Bitergia.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>